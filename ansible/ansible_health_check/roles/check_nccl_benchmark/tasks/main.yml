---
- name: Check for NVIDIA GPU presence before running NCCL tests
  ansible.builtin.command: nvidia-smi
  register: nvidia_check
  changed_when: false
  failed_when: false

- name: Skip NCCL benchmark if no NVIDIA GPU is found
  when: nvidia_check.rc != 0
  block:
    - name: Create NCCL skip result object
      ansible.builtin.set_fact:
        nccl_skip_result:
          name: "NCCL Benchmark (all_reduce_perf)"
          command: "N/A"
          result: "Skipped: No NVIDIA GPU detected or nvidia-smi not found."
          status: "PARTIAL"
          notes: ""
    - name: Append NCCL skip result
      ansible.builtin.set_fact:
        test_results: "{{ test_results | combine({'nccl_benchmark': test_results.nccl_benchmark + [nccl_skip_result]}, recursive=True) }}"

- name: Add NVIDIA CUDA network repository
  block:
    - name: Download the CUDA network repository keyring package
      ansible.builtin.get_url:
        url: https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb
        dest: /tmp/cuda-keyring.deb
        mode: '0644'
      become: true

    - name: Install the CUDA network repository keyring
      ansible.builtin.apt:
        deb: /tmp/cuda-keyring.deb
      become: true

- name: Build and run NCCL tests from source
  when: nvidia_check.rc == 0
  become: true
  block:
    - name: Install NCCL and CUDA build dependencies
      ansible.builtin.package:
        name:
          - build-essential
          - git
          - cuda-toolkit # This provides the required compiler and headers
          - libnccl-dev    # This provides the NCCL library headers
        state: present
        update_cache: yes

    - name: Clone the NCCL-Tests repository
      ansible.builtin.git:
        repo: 'https://github.com/NVIDIA/nccl-tests.git'
        dest: /usr/local/nccl-tests
        version: master

    - name: Compile the NCCL tests
      ansible.builtin.command: make
      args:
        chdir: /usr/local/nccl-tests/
        creates: /usr/local/nccl-tests/build/all_reduce_perf # Skips if already compiled

    - name: Run a sample NCCL benchmark (all_reduce_perf)
      ansible.builtin.command: /usr/local/nccl-tests/build/all_reduce_perf -b 8 -e 128M -f 2 -g 1
      register: nccl_result
      changed_when: false
      failed_when: false

    - name: Create NCCL result object
      ansible.builtin.set_fact:
        nccl_benchmark_result:
          name: "NCCL Benchmark (all_reduce_perf)"
          command: "all_reduce_perf -b 8 -e 128M -f 2 -g 1"
          result: "{{ nccl_result.stdout if nccl_result.rc == 0 else nccl_result.stderr }}"
          status: "{{ (nccl_result.rc == 0) | ternary('PASS', 'FAIL') }}"
          notes: "<details><summary>Show full benchmark output</summary><pre>{{ nccl_result.stdout }}</pre></details>"

    - name: Append NCCL Benchmark result
      ansible.builtin.set_fact:
        test_results: "{{ test_results | combine({'nccl_benchmark': test_results.nccl_benchmark + [nccl_benchmark_result]}, recursive=True) }}"
